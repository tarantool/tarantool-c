name: packaging

on: [push, pull_request]

jobs:
  build_package:
    # Skip pull request jobs when the source branch is in the same
    # repository.
    if: |
      github.event_name == 'push' ||
      github.event.pull_request.head.repo.full_name != github.repository
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        platform:
          - { os: 'debian', dist: 'stretch' }
          - { os: 'debian', dist: 'buster' }
          - { os: 'debian', dist: 'bullseye' }
          - { os: 'el', dist: '7' }
          - { os: 'el', dist: '8' }
          - { os: 'fedora', dist: '30' }
          - { os: 'fedora', dist: '31' }
          - { os: 'fedora', dist: '32' }
          - { os: 'fedora', dist: '33' }
          - { os: 'fedora', dist: '34' }
          - { os: 'opensuse-leap', dist: '15.1' }
          - { os: 'opensuse-leap', dist: '15.2' }
          - { os: 'ubuntu', dist: 'xenial' }
          - { os: 'ubuntu', dist: 'bionic' }
          - { os: 'ubuntu', dist: 'focal' }
          - { os: 'ubuntu', dist: 'hirsute' }

    env:
      OS: ${{ matrix.platform.os }}
      DIST: ${{ matrix.platform.dist }}

    steps:
      - name: Clone the module
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Clone the packpack tool
        uses: actions/checkout@v2
        with:
          repository: packpack/packpack
          path: packpack

      - name: Create packages
        run: ./packpack/packpack
